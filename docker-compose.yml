x-build: &build
  build:
    context: .
    dockerfile: Dockerfile.dev
    args:
      USER_ID: ${USER_ID:-1000}
      GROUP_ID: ${GROUP_ID:-1000}

x-service-base: &service-base
  <<: *build
  volumes:
    - .:/workspace
    - node_modules:/workspace/node_modules

x-db-base: &db-base
  image: postgres:15-alpine
  healthcheck:
    test: ["CMD-SHELL", "pg_isready -U postgres"]
    interval: 5s
    timeout: 5s
    retries: 5

services:
  init:
    <<: *build
    working_dir: /workspace
    command: sh -c "yarn && yarn build"
    volumes:
      - .:/workspace
      - node_modules:/workspace/node_modules
      - /workspace/apps/notifications-service/pulumi

  packages:
    <<: *build
    working_dir: /workspace
    command: sh -c "yarn turbo run dev --filter='@shapeshift/shared-types' --filter='@shapeshift/shared-utils'"
    volumes:
      - .:/workspace
      - node_modules:/workspace/node_modules
    depends_on:
      init:
        condition: service_completed_successfully

  user-service:
    <<: *service-base
    working_dir: /workspace/apps/user-service
    command: sh -c "yarn db:push && yarn start:dev"
    ports:
      - "3002:3002"
    env_file:
      - ./apps/user-service/.env
    environment:
      - NODE_ENV=development
      - PORT=3002
    depends_on:
      packages:
        condition: service_started
      user-db:
        condition: service_healthy

  swap-service:
    <<: *service-base
    working_dir: /workspace/apps/swap-service
    command: sh -c "yarn db:push && yarn start:dev"
    ports:
      - "3001:3001"
    env_file:
      - ./apps/swap-service/.env
    environment:
      - NODE_ENV=development
      - PORT=3001
    depends_on:
      packages:
        condition: service_started
      swap-db:
        condition: service_healthy

  notifications-service:
    <<: *service-base
    working_dir: /workspace/apps/notifications-service
    command: sh -c "yarn db:push && yarn start:dev"
    ports:
      - "3003:3003"
    env_file:
      - ./apps/notifications-service/.env
    environment:
      - NODE_ENV=development
      - PORT=3003
    depends_on:
      packages:
        condition: service_started
      user-service:
        condition: service_started
      notifications-db:
        condition: service_healthy

  user-db:
    <<: *db-base
    environment:
      - POSTGRES_DB=user_service
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    ports:
      - "5432:5432"
    volumes:
      - user_db_data:/var/lib/postgresql/data

  swap-db:
    <<: *db-base
    environment:
      - POSTGRES_DB=swap_service
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    ports:
      - "5433:5432"
    volumes:
      - swap_db_data:/var/lib/postgresql/data

  notifications-db:
    <<: *db-base
    environment:
      - POSTGRES_DB=notifications_service
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    ports:
      - "5434:5432"
    volumes:
      - notifications_db_data:/var/lib/postgresql/data

volumes:
  node_modules:
  user_db_data:
  swap_db_data:
  notifications_db_data:
